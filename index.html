<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARC Raiders Quest Tracker</title>
    <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
        }

        #app {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #4fc3f7;
            font-size: 2.5em;
            text-shadow: 0 0 10px rgba(79, 195, 247, 0.5);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .control-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            background: #2c2c2c;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        button:hover {
            background: #3c3c3c;
            border-color: #666;
        }

        #quest-container {
            width: 100%;
            height: 800px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 8px;
        }

        .stats {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: #2c2c2c;
            border-radius: 8px;
        }

        .stats-content {
            display: flex;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #4fc3f7;
        }

        .stat-label {
            font-size: 0.9em;
            color: #888;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>ARC Raiders Quest Tracker</h1>
        <div class="controls">
            <div class="control-group">
                <button onclick="resetProgress()">Reset All Progress</button>
                <button onclick="exportProgress()">Export Progress</button>
                <button onclick="importProgress()">Import Progress</button>
            </div>
            <div class="control-group">
                <button onclick="focusAvailable()">Focus Available Quests</button>
                <button onclick="zoomIn()">Zoom In (+)</button>
                <button onclick="zoomOut()">Zoom Out (-)</button>
                <button onclick="fitGraph()">Fit All</button>
            </div>
        </div>
        <div id="quest-container"></div>
        <div class="stats">
            <div class="stats-content">
                <div class="stat-item">
                    <div class="stat-value" id="completed-count">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="available-count">0</div>
                    <div class="stat-label">Available</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="total-count">0</div>
                    <div class="stat-label">Total Quests</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const QUESTS = [{"id":"map_dam_battleground","name":"ðŸ—ºï¸ Dam Battleground","trader":"Map","previousQuestIds":[],"nextQuestIds":["ss1"]},{"id":"map_blue_gate","name":"ðŸ—ºï¸ Blue Gate","trader":"Map","previousQuestIds":[],"nextQuestIds":["ss11"]},{"id":"map_stella_montis","name":"ðŸ—ºï¸ Stella Montis","trader":"Map","previousQuestIds":[],"nextQuestIds":["12_in_my_image"]},{"id":"ss5","name":"A Bad Feeling","trader":"Celeste","previousQuestIds":["ss4"],"nextQuestIds":["ss5a","ss7","ss8"]},{"id":"ss10x","name":"A Balanced Harvest","trader":"Celeste","previousQuestIds":["ss10s"],"nextQuestIds":["ss10x2"]},{"id":"ss10","name":"A Better Use","trader":"Tian Wen","previousQuestIds":["ss7"],"nextQuestIds":["ss10a"]},{"id":"ss11","name":"A First Foothold","trader":"Shani","previousQuestIds":["map_blue_gate"],"nextQuestIds":["ss11a"]},{"id":"ss10k","name":"A Lay of the Land","trader":"Shani","previousQuestIds":["ss10g"],"nextQuestIds":["ss10s"]},{"id":"ss10x19","name":"A New Type of Plant","trader":"Lance","previousQuestIds":["ss10x18"],"nextQuestIds":["ss10x20"]},{"id":"ss10g","name":"A Reveal in Ruins","trader":"Lance","previousQuestIds":["ss10f"],"nextQuestIds":["ss10k"]},{"id":"ss10r","name":"A Symbol of Unification","trader":"Celeste","previousQuestIds":["ss10q"],"nextQuestIds":["ss10t","ss10u","ss10v"]},{"id":"a_toxic_trail","name":"A Toxic Trail","trader":"Shani","previousQuestIds":["ss10x20"],"nextQuestIds":["the_stench_of_corruption"]},{"id":"ss10x8","name":"A Warm Place to Rest","trader":"Apollo","previousQuestIds":["ss10x7"],"nextQuestIds":["ss10x9"]},{"id":"ss10y","name":"After Rain Comes","trader":"Celeste","previousQuestIds":["ss10s"],"nextQuestIds":["ss10x4"]},{"id":"ss10x20","name":"Armored Transports","trader":"Shani","previousQuestIds":["ss10x19","ss11bx"],"nextQuestIds":["a_toxic_trail","paving_the_way","the_clean_dream"]},{"id":"ss10w","name":"Back on Top","trader":"Tian Wen","previousQuestIds":["ss10t"],"nextQuestIds":["ss10z"]},{"id":"ss10x12","name":"Bees!","trader":"Celeste","previousQuestIds":["ss10x11"],"nextQuestIds":["ss10x13"]},{"id":"ss10h","name":"Broken Monument","trader":"Tian Wen","previousQuestIds":["ss10e"],"nextQuestIds":["ss10i","ss10j"]},{"id":"ss10x18","name":"Building a Library","trader":"Apollo","previousQuestIds":["ss10x16"],"nextQuestIds":["ss10x19"]},{"id":"ss10t","name":"Celeste's Journals","trader":"Celeste","previousQuestIds":["ss10r"],"nextQuestIds":["ss10w"]},{"id":"ss2","name":"Clearer Skies","trader":"Shani","previousQuestIds":["ss1"],"nextQuestIds":["ss4"]},{"id":"12_cold_storage","name":"Cold Storage","trader":"Celeste","previousQuestIds":["12_in_my_image"],"nextQuestIds":["12_snap_and_salvage"]},{"id":"ss11b2","name":"Communication Hideout","trader":"Shani","previousQuestIds":["ss11b"],"nextQuestIds":["ss10x5"]},{"id":"deciphering_the_data","name":"Deciphering the Data","trader":"Shani","previousQuestIds":["a_toxic_trail","paving_the_way"],"nextQuestIds":["groundbreaking"]},{"id":"ss10x16","name":"Digging Up Dirt","trader":"Celeste","previousQuestIds":["ss10x15"],"nextQuestIds":["ss10x17","ss10x18"]},{"id":"ss10c","name":"Doctor's Orders","trader":"Celeste","previousQuestIds":["ss10a"],"nextQuestIds":["ss10f"]},{"id":"ss10b","name":"Dormant Barons","trader":"Shani","previousQuestIds":["ss10a"],"nextQuestIds":["ss10d","ss10e"]},{"id":"ss6","name":"Down To Earth","trader":"Shani","previousQuestIds":["ss5a"],"nextQuestIds":["ss9"]},{"id":"ss10p","name":"Echoes of Victory Ridge","trader":"Celeste","previousQuestIds":["ss10o"],"nextQuestIds":["ss10q"]},{"id":"ss10x13","name":"Espresso","trader":"Apollo","previousQuestIds":["ss10x12"],"nextQuestIds":["ss10x14"]},{"id":"ss10s","name":"Eyes in the Sky","trader":"Shani","previousQuestIds":["ss10k"],"nextQuestIds":["ss10w","ss10x","ss10y"]},{"id":"ss10m","name":"Eyes on the Prize","trader":"Tian Wen","previousQuestIds":["ss10l"],"nextQuestIds":["ss10n"]},{"id":"ss10x11","name":"Flickering Threat","trader":"Celeste","previousQuestIds":["ss10x10"],"nextQuestIds":["ss10x12"]},{"id":"ss10a","name":"Greasing Her Palms","trader":"Celeste","previousQuestIds":["ss10"],"nextQuestIds":["ss10b","ss10c"]},{"id":"groundbreaking","name":"Groundbreaking","trader":"Apollo","previousQuestIds":["deciphering_the_data"],"nextQuestIds":[]},{"id":"ss5a","name":"Hatch Repairs","trader":"Shani","previousQuestIds":["ss5"],"nextQuestIds":["ss6"]},{"id":"12_in_my_image","name":"In My Image","trader":"Lance","previousQuestIds":["map_stella_montis"],"nextQuestIds":["12_cold_storage"]},{"id":"ss10n","name":"Industrial Espionage","trader":"Tian Wen","previousQuestIds":["ss10m"],"nextQuestIds":["ss10q"]},{"id":"ss10x5","name":"Into the Fray","trader":"Shani","previousQuestIds":["ss10x4","ss11b2"],"nextQuestIds":[]},{"id":"ss10o","name":"Keeping the Memory","trader":"Celeste","previousQuestIds":["ss10j"],"nextQuestIds":["ss10p"]},{"id":"ss10x14","name":"Life of a Pharmacist","trader":"Lance","previousQuestIds":["ss10x13"],"nextQuestIds":["ss10x15"]},{"id":"ss11b","name":"Lost in Transmission","trader":"Shani","previousQuestIds":["ss10z"],"nextQuestIds":["ss11b2"]},{"id":"ss10i","name":"Marked for Death","trader":"Tian Wen","previousQuestIds":["ss10h"],"nextQuestIds":["ss10l"]},{"id":"ss10l","name":"Market Correction","trader":"Tian Wen","previousQuestIds":["ss10i"],"nextQuestIds":["ss10m"]},{"id":"ss10f","name":"Medical Merchandise","trader":"Lance","previousQuestIds":["ss10c"],"nextQuestIds":["ss10g"]},{"id":"ss10d","name":"Mixed Signals","trader":"Tian Wen","previousQuestIds":["ss10b"],"nextQuestIds":[]},{"id":"ss4","name":"Off The Radar","trader":"Shani","previousQuestIds":["ss2","ss3"],"nextQuestIds":["ss5"]},{"id":"ss10z","name":"Our Presence Up There","trader":"Shani","previousQuestIds":["ss10w"],"nextQuestIds":["ss11b"]},{"id":"ss10v","name":"Out of the Shadows","trader":"Shani","previousQuestIds":["ss10r"],"nextQuestIds":[]},{"id":"paving_the_way","name":"Paving the Way","trader":"Apollo","previousQuestIds":["ss10x20"],"nextQuestIds":["deciphering_the_data"]},{"id":"ss1","name":"Picking Up The Pieces","trader":"Shani","previousQuestIds":["map_dam_battleground"],"nextQuestIds":["ss2","ss3"]},{"id":"ss10x10","name":"Power Out","trader":"Celeste","previousQuestIds":["ss10x9"],"nextQuestIds":["ss10x11"]},{"id":"ss10x9","name":"Prescriptions of the Past","trader":"Lance","previousQuestIds":["ss10x8"],"nextQuestIds":["ss10x10"]},{"id":"ss11a","name":"Reduced to Rubble","trader":"Shani","previousQuestIds":["ss11"],"nextQuestIds":["ss11bx"]},{"id":"ss8","name":"Safe Passage","trader":"Apollo","previousQuestIds":["ss5"],"nextQuestIds":["ss8a"]},{"id":"12_snap_and_salvage","name":"Snap and Salvage","trader":"Tian Wen","previousQuestIds":["12_cold_storage"],"nextQuestIds":[]},{"id":"ss10x6","name":"Source of the Contamination","trader":"Celeste","previousQuestIds":["ss10x4"],"nextQuestIds":["ss10x7"]},{"id":"ss8b","name":"Sparks Fly","trader":"Apollo","previousQuestIds":["ss8a"],"nextQuestIds":[]},{"id":"ss10j","name":"Straight Record","trader":"Celeste","previousQuestIds":["ss10h"],"nextQuestIds":["ss10o"]},{"id":"ss10x7","name":"Switching the Supply","trader":"Celeste","previousQuestIds":["ss10x6"],"nextQuestIds":["ss10x8"]},{"id":"the_clean_dream","name":"The Clean Dream","trader":"Apollo","previousQuestIds":["ss10x20"],"nextQuestIds":[]},{"id":"ss10u","name":"The Major's Footlocker","trader":"Tian Wen","previousQuestIds":["ss10r"],"nextQuestIds":[]},{"id":"ss7","name":"The Right Tool","trader":"Tian Wen","previousQuestIds":["ss5"],"nextQuestIds":["ss10"]},{"id":"ss10x3","name":"The Root of the Matter","trader":"Celeste","previousQuestIds":["ss10x2"],"nextQuestIds":["ss10x4"]},{"id":"the_stench_of_corruption","name":"The Stench of Corruption","trader":"Shani","previousQuestIds":["a_toxic_trail"],"nextQuestIds":[]},{"id":"ss9","name":"The Trifecta","trader":"Shani","previousQuestIds":["ss6"],"nextQuestIds":[]},{"id":"ss3","name":"Trash Into Treasure","trader":"Shani","previousQuestIds":["ss1"],"nextQuestIds":["ss4"]},{"id":"ss10x15","name":"Tribute to Toledo","trader":"Celeste","previousQuestIds":["ss10x14"],"nextQuestIds":["ss10x16"]},{"id":"ss10x17","name":"Turnabout","trader":"Celeste","previousQuestIds":["ss10x16"],"nextQuestIds":[]},{"id":"ss10q","name":"Unexpected Initiative","trader":"Tian Wen","previousQuestIds":["ss10p","ss10n"],"nextQuestIds":["ss10r"]},{"id":"ss10x2","name":"Untended Garden","trader":"Celeste","previousQuestIds":["ss10x"],"nextQuestIds":["ss10x3"]},{"id":"ss10x4","name":"Water Troubles","trader":"Celeste","previousQuestIds":["ss10x3","ss10y"],"nextQuestIds":["ss10x5","ss10x6"]},{"id":"ss8a","name":"What Goes Around","trader":"Apollo","previousQuestIds":["ss8"],"nextQuestIds":["ss8b"]},{"id":"ss10e","name":"What We Left Behind","trader":"Tian Wen","previousQuestIds":["ss10b"],"nextQuestIds":["ss10h"]},{"id":"ss11bx","name":"With a Trace","trader":"Shani","previousQuestIds":["ss11a"],"nextQuestIds":[]}];

        let completedQuests = new Set();
        let questMap = new Map();

        // Initialize quest map
        QUESTS.forEach(q => questMap.set(q.id, q));

        // Load progress from localStorage
        function loadProgress() {
            const saved = localStorage.getItem('arcraiders-quest-progress');
            if (saved) {
                completedQuests = new Set(JSON.parse(saved));
            }
        }

        // Save progress to localStorage
        function saveProgress() {
            localStorage.setItem('arcraiders-quest-progress', JSON.stringify([...completedQuests]));
        }

        // Check if quest is available
        function isQuestAvailable(quest) {
            if (completedQuests.has(quest.id)) return false;
            if (quest.previousQuestIds.length === 0) return true;
            return quest.previousQuestIds.every(id => completedQuests.has(id));
        }

        // Get all prerequisite quests that need to be completed before this quest
        function getPrerequisiteQuests(questId) {
            const prerequisites = [];
            const toCheck = [questId];
            const visited = new Set();
            
            while (toCheck.length > 0) {
                const current = toCheck.shift();
                if (visited.has(current)) continue;
                visited.add(current);
                
                prerequisites.push(current);
                
                // Find all prerequisite quests for the current quest
                const quest = questMap.get(current);
                if (quest && quest.previousQuestIds) {
                    quest.previousQuestIds.forEach(prevId => {
                        if (!completedQuests.has(prevId)) {
                            toCheck.push(prevId);
                        }
                    });
                }
            }
            
            return prerequisites;
        }

        // Get trader color
        function getTraderColor(trader) {
            const colors = {
                'Celeste': '#7b1fa2',
                'Shani': '#f57c00',
                'Lance': '#388e3c',
                'Tian Wen': '#c62828',
                'Apollo': '#0277bd'
            };
            return colors[trader] || '#616161';
        }

        // Toggle quest completion
        function toggleQuest(questId) {
            const quest = questMap.get(questId);
            
            if (completedQuests.has(questId)) {
                // Uncompleting - check for dependent quests
                const dependents = QUESTS.filter(q => 
                    q.previousQuestIds.includes(questId) && completedQuests.has(q.id)
                );
                
                if (dependents.length > 1) {
                    if (!confirm(`Unmarking "${quest.name}" will also unmark ${dependents.length} dependent quests. Continue?`)) {
                        return;
                    }
                }
                
                // Unmark this quest and all dependents
                completedQuests.delete(questId);
                dependents.forEach(d => {
                    unmarkQuestAndDependents(d.id);
                });
            } else {
                // Mark as completed - also mark all prerequisite quests
                const prerequisites = getPrerequisiteQuests(questId);
                
                if (prerequisites.length > 1) {
                    if (!confirm(`Marking "${quest.name}" as complete will also mark ${prerequisites.length - 1} prerequisite quest${prerequisites.length - 1 > 1 ? 's' : ''} as complete. Continue?`)) {
                        return;
                    }
                }
                
                prerequisites.forEach(qid => completedQuests.add(qid));
            }
            
            saveProgress();
            updateGraph();
        }

        function unmarkQuestAndDependents(questId) {
            completedQuests.delete(questId);
            const dependents = QUESTS.filter(q => 
                q.previousQuestIds.includes(questId) && completedQuests.has(q.id)
            );
            dependents.forEach(d => unmarkQuestAndDependents(d.id));
        }

        // Cytoscape graph
        let cy = null;
        let minZoomLevel = null;  // Store minimum zoom level (fit all level)

        // Initialize Cytoscape graph
        function initGraph() {
            // Build nodes and edges
            const elements = [];
            
            // Define quest chain ordering to minimize crossings
            // Lower priority = placed on the left
            const questPriorities = {
                // Far left: A First Foothold chain (highest priority to keep leftmost)
                'ss11': -1000,
                'ss11a': -1000,
                'ss11bx': -1000,
                // Also prioritize ss10x20 which connects to ss11bx
                'ss10x20': -900,
                // Keep these chains separated from the right side quests
            };
            
            // Sort quests: priority quests first, then rest
            const sortedQuests = [...QUESTS].sort((a, b) => {
                const prioA = questPriorities[a.id] || 0;
                const prioB = questPriorities[b.id] || 0;
                return prioA - prioB;
            });
            
            // Add nodes
            sortedQuests.forEach(quest => {
                const isCompleted = completedQuests.has(quest.id);
                const isAvailable = isQuestAvailable(quest);
                const priority = questPriorities[quest.id] || 0;
                
                // Map nodes: only show name, Quest nodes: show ID and name
                const label = quest.trader === 'Map' ? quest.name : quest.name;
                
                elements.push({
                    data: { 
                        id: quest.id, 
                        label: label,
                        questId: quest.id,
                        name: quest.name,
                        trader: quest.trader,
                        completed: isCompleted,
                        available: isAvailable,
                        priority: priority
                    }
                });
            });
            
            // Add edges
            QUESTS.forEach(quest => {
                quest.previousQuestIds.forEach(prevId => {
                    const sourceCompleted = completedQuests.has(prevId);
                    const targetCompleted = completedQuests.has(quest.id);
                    const targetAvailable = isQuestAvailable(quest);
                    
                    elements.push({
                        data: { 
                            source: prevId, 
                            target: quest.id,
                            completed: sourceCompleted && targetCompleted,
                            available: sourceCompleted && targetAvailable
                        }
                    });
                });
            });
            
            // Initialize Cytoscape
            cy = cytoscape({
                container: document.getElementById('quest-container'),
                elements: elements,
                userZoomingEnabled: true,
                userPanningEnabled: true,
                boxSelectionEnabled: false,
                autoungrabify: true,  // Disable node dragging
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': function(ele) {
                                // For map nodes: just the name
                                // For quest nodes: ID (smaller appearance) and name
                                if (ele.data('trader') === 'Map') {
                                    return ele.data('label');
                                } else {
                                    // Format: small ID in parentheses, then larger name
                                    return '(' + ele.data('questId') + ')\n\n' + ele.data('name');
                                }
                            },
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'text-wrap': 'wrap',
                            'text-max-width': '220px',
                            'width': 250,
                            'height': 90,
                            'shape': 'roundrectangle',
                            'background-color': '#2c2c2c',
                            'border-width': 2,
                            'border-color': '#444',
                            'color': '#e0e0e0',
                            'font-size': '14px',
                            'font-weight': 'bold',
                            'font-family': 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif',
                            'line-height': 1.2
                        }
                    },
                    {
                        selector: 'node[trader="Map"]',
                        style: {
                            'label': 'data(label)',
                            'width': 200,
                            'height': 60,
                            'background-color': '#1a1a1a',
                            'border-color': '#455a64',
                            'border-width': 3,
                            'font-size': '15px',
                            'font-weight': 'bold'
                        }
                    },
                    {
                        selector: 'node[completed]',
                        style: {
                            'background-color': ele => ele.data('completed') ? '#1b4d2b' : '#2c2c2c',
                            'border-color': ele => ele.data('completed') ? '#2e7d4e' : '#444',
                            'border-width': ele => ele.data('completed') ? 3 : 2
                        }
                    },
                    {
                        selector: 'node[available]',
                        style: {
                            'border-color': ele => ele.data('available') && !ele.data('completed') ? '#ffd700' : null,
                            'border-width': ele => ele.data('available') && !ele.data('completed') ? 3 : 2
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 2,
                            'line-color': '#555',
                            'target-arrow-color': '#555',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier',
                            'arrow-scale': 1.5
                        }
                    },
                    {
                        selector: 'edge[completed]',
                        style: {
                            'line-color': ele => ele.data('completed') ? '#2e7d4e' : '#555',
                            'target-arrow-color': ele => ele.data('completed') ? '#2e7d4e' : '#555',
                            'width': ele => ele.data('completed') ? 2.5 : 2
                        }
                    },
                    {
                        selector: 'edge[available]',
                        style: {
                            'line-color': ele => ele.data('available') && !ele.data('completed') ? '#888' : null,
                            'target-arrow-color': ele => ele.data('available') && !ele.data('completed') ? '#888' : null,
                            'width': ele => ele.data('available') && !ele.data('completed') ? 2.5 : 2
                        }
                    }
                ],
                layout: {
                    name: 'dagre',
                    rankDir: 'TB',
                    nodeSep: 80,
                    rankSep: 100,
                    padding: 30,
                    ranker: 'network-simplex',
                    align: 'UL',  // Align nodes to upper-left
                    // Sort nodes by priority to control horizontal ordering
                    sortOrder: function(a, b) {
                        const priorityA = a.data('priority') || 0;
                        const priorityB = b.data('priority') || 0;
                        if (priorityA !== priorityB) {
                            return priorityA - priorityB;
                        }
                        // Secondary sort by ID
                        return a.id().localeCompare(b.id());
                    }
                }
            });
            
            // Add click handler
            cy.on('tap', 'node', function(evt) {
                const questId = evt.target.id();
                toggleQuest(questId);
            });
            
            // Add hover tooltip
            cy.on('mouseover', 'node', function(evt) {
                const node = evt.target;
                const quest = questMap.get(node.id());
                if (quest) {
                    node.style('background-color', '#3c3c3c');
                }
            });
            
            cy.on('mouseout', 'node', function(evt) {
                const node = evt.target;
                const isCompleted = node.data('completed');
                node.style('background-color', isCompleted ? '#1b4d2b' : '#2c2c2c');
            });
            
            // Add right-click for wiki link
            cy.on('cxttap', 'node', function(evt) {
                const questId = evt.target.id();
                const quest = questMap.get(questId);
                if (quest) {
                    const wikiLink = quest.name.split(' ').map(word => 
                        word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                    ).join('_');
                    window.open(`https://arcraiders.wiki/wiki/${wikiLink}`, '_blank');
                }
            });
            
            // Constrain zoom to not go below fit level
            cy.on('zoom', function() {
                if (minZoomLevel !== null && cy.zoom() < minZoomLevel) {
                    cy.zoom(minZoomLevel);
                }
            });
            
            // Calculate and store minimum zoom level after layout
            setTimeout(() => {
                cy.fit(null, 30);
                minZoomLevel = cy.zoom();
                focusAvailable();
            }, 100);
        }

        // Update graph with current state
        function updateGraph() {
            if (!cy) return;
            
            // Start batch to avoid multiple redraws
            cy.startBatch();
            
            cy.nodes().forEach(node => {
                const questId = node.id();
                const quest = questMap.get(questId);
                const isCompleted = completedQuests.has(questId);
                const isAvailable = isQuestAvailable(quest);
                
                node.data('completed', isCompleted);
                node.data('available', isAvailable);
                
                // Reset all node styles explicitly
                if (isCompleted) {
                    node.style({
                        'background-color': '#1b4d2b',
                        'border-color': '#2e7d4e',
                        'border-width': 3
                    });
                } else if (isAvailable) {
                    node.style({
                        'background-color': '#2c2c2c',
                        'border-color': '#ffd700',
                        'border-width': 3
                    });
                } else {
                    node.style({
                        'background-color': '#2c2c2c',
                        'border-color': '#444',
                        'border-width': 2
                    });
                }
            });
            
            cy.edges().forEach(edge => {
                const sourceId = edge.source().id();
                const targetId = edge.target().id();
                const sourceCompleted = completedQuests.has(sourceId);
                const targetCompleted = completedQuests.has(targetId);
                const targetQuest = questMap.get(targetId);
                const targetAvailable = isQuestAvailable(targetQuest);
                
                edge.data('completed', sourceCompleted && targetCompleted);
                edge.data('available', sourceCompleted && targetAvailable);
            });
            
            cy.endBatch();
            
            updateStats();
        }

        // Update stats
        function updateStats() {
            const available = QUESTS.filter(q => isQuestAvailable(q)).length;
            document.getElementById('completed-count').textContent = completedQuests.size;
            document.getElementById('available-count').textContent = available;
            document.getElementById('total-count').textContent = QUESTS.length;
        }

        // Zoom and focus controls
        function focusAvailable() {
            if (!cy) return;
            
            // Get available quest nodes
            const availableNodes = cy.nodes().filter(node => {
                const questId = node.id();
                const quest = questMap.get(questId);
                return quest && isQuestAvailable(quest) && !completedQuests.has(questId);
            });
            
            if (availableNodes.length === 0) {
                // If no available quests, fit the whole graph
                fitGraph();
                return;
            }
            
            // Get all predecessors and successors for context
            const contextNodes = availableNodes.union(
                availableNodes.predecessors('node'),
                availableNodes.successors('node')
            );
            
            // Fit to these nodes with padding
            cy.fit(contextNodes, 50);
            
            // If the zoom is too close, zoom out a bit for better context
            if (cy.zoom() > 1.2) {
                cy.zoom({
                    level: Math.min(cy.zoom(), 1.2),
                    renderedPosition: { x: cy.width() / 2, y: cy.height() / 2 }
                });
            }
        }

        function zoomIn() {
            if (!cy) return;
            cy.zoom({
                level: cy.zoom() * 1.2,
                renderedPosition: { x: cy.width() / 2, y: cy.height() / 2 }
            });
        }

        function zoomOut() {
            if (!cy) return;
            const newZoom = cy.zoom() * 0.8;
            // Don't zoom out past the minimum (fit all) level
            const targetZoom = minZoomLevel !== null ? Math.max(newZoom, minZoomLevel) : newZoom;
            cy.zoom({
                level: targetZoom,
                renderedPosition: { x: cy.width() / 2, y: cy.height() / 2 }
            });
        }

        function fitGraph() {
            if (!cy) return;
            cy.fit(null, 30);
            minZoomLevel = cy.zoom();  // Update minimum zoom level
        }

        // Controls
        function resetProgress() {
            if (confirm('Reset all quest progress? This cannot be undone.')) {
                completedQuests.clear();
                saveProgress();
                updateGraph();
            }
        }

        function exportProgress() {
            const data = JSON.stringify([...completedQuests]);
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'arcraiders-quest-progress.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importProgress() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        completedQuests = new Set(data);
                        saveProgress();
                        updateGraph();
                        alert('Progress imported successfully!');
                    } catch (err) {
                        alert('Error importing progress: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Initialize
        loadProgress();
        initGraph();
        updateStats();
    </script>
</body>
</html>